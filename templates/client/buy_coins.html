{% extends "base.html" %}

{% block title %}Buy Coins{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-coins"></i> Buy Coins</h2>
        <p class="text-muted">Purchase coins to perform searches. Each search costs 1 coin.</p>
        <hr>
    </div>
</div>

<div class="row">
    {% for package in packages %}
    <div class="col-md-4 mb-4">
        <div class="card h-100 {{ 'border-warning' if loop.index == 2 else '' }}">
            {% if loop.index == 2 %}
            <div class="card-header bg-warning text-center">
                <small>MOST POPULAR</small>
            </div>
            {% endif %}
            <div class="card-body text-center">
                <h4>{{ package.name }}</h4>
                <div class="display-4 text-primary">${{ "%.2f"|format(package.price_dollars) }}</div>
                <p class="lead">{{ package.coins }} coins</p>
                <p class="text-muted">${{ "%.3f"|format(package.price_dollars / package.coins) }} per coin</p>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="buyPackage({{ package.id }}, '{{ package.name }}', {{ package.price_cents }})">
                        <i class="fas fa-credit-card"></i> Pay with Stripe
                    </button>
                    <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#manualPaymentModal{{ package.id }}">
                        <i class="fas fa-university"></i> Manual Payment
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Manual Payment Modal -->
    <div class="modal fade" id="manualPaymentModal{{ package.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manual Payment Request - {{ package.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('request_manual_payment') }}">
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <strong>{{ package.coins }} coins</strong> for <strong>${{ "%.2f"|format(package.price_dollars) }}</strong>
                        </div>
                        
                        <input type="hidden" name="package_id" value="{{ package.id }}">
                        
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <select class="form-select" name="payment_method" required>
                                <option value="">Choose payment method...</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="paypal">PayPal</option>
                                <option value="crypto">Cryptocurrency</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="payment_notes{{ package.id }}" class="form-label">Payment Details/Reference</label>
                            <textarea class="form-control" id="payment_notes{{ package.id }}" name="payment_notes" rows="3" 
                                    placeholder="Enter transaction ID, payment reference, or other details..."></textarea>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <small>Your coins will be added after admin approval. Please include payment proof or reference details.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Submit Payment Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="row mt-4">
    <div class="col-md-8 mx-auto">
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> About Our Coin System</h5>
            <ul class="mb-0">
                <li>Each keyword search costs 1 coin</li>
                <li>Coins never expire</li>
                <li><strong>Stripe:</strong> Instant automated payment processing</li>
                <li><strong>Manual Payment:</strong> Bank transfer, PayPal, crypto - requires admin approval</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe('{{ stripe_public_key }}');

function buyPackage(packageId, packageName, priceInCents) {
    // Create payment intent
    fetch('/create-payment-intent', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            package_id: packageId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        // Confirm payment
        return stripe.confirmCardPayment(data.client_secret, {
            payment_method: {
                card: {
                    // This would need a proper card element in production
                    // For demo purposes, using test payment method
                }
            }
        });
    })
    .then(result => {
        if (result.error) {
            alert('Payment failed: ' + result.error.message);
        } else {
            window.location.href = '/payment-success?payment_intent=' + result.paymentIntent.id;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Payment error: ' + error.message);
    });
}
</script>
{% endblock %}