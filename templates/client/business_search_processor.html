{% extends "base.html" %}

{% block title %}Business Search Processing{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-cogs"></i> Keyword Search Processing</h2>
        <p class="text-muted">Searching for "<strong>{{ session.keywords }}</strong>" keywords using Google Web Search to find maximum URLs and page titles.</p>
        <hr>
    </div>
</div>

<!-- Processing Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-spinner fa-spin" id="spinnerIcon"></i> Processing Status</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" id="progressBar"
                             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <strong>Status:</strong> <span id="statusText" class="badge bg-warning">Starting...</span>
                    </div>
                    <div class="col-md-6">
                        <strong id="currentLocationLabel">Current Keyword:</strong> <span id="currentLocation" class="text-muted">-</span>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h4 id="totalBusinesses">0</h4>
                                <small>URLs Found</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h4 id="keywordsProcessed">0</h4>
                                <small id="keywordsLabel">Keywords Processed</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h4 id="processingTime">0s</h4>
                                <small>Processing Time</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h4 id="averagePerKeyword">0</h4>
                                <small id="averageLabel">Avg. URLs per Keyword</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Keyword Progress (for bulk searches) -->
<div class="row mb-4" id="keywordProgressSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-list"></i> Keyword Progress</h5>
            </div>
            <div class="card-body">
                <div id="keywordProgressList">
                    <!-- Keyword progress items will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Processing Details -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Search Details</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-search"></i> Search Configuration</h6>
                    <ul class="mb-0">
                        <li><strong>Keywords:</strong> {{ session.keywords }}</li>
                        <li><strong>Search Type:</strong> Google Web Search</li>
                        <li><strong>Max URLs per Keyword:</strong> {{ session.max_results_per_city }}</li>
                        <li><strong>Expected Total:</strong> Up to {{ (session.keywords.split('\n')|length) * session.max_results_per_city }} URLs</li>
                    </ul>
                </div>
                
                <h6>Keywords to Process:</h6>
                <div class="row">
                    {% for keyword in session.keywords.split('\n') %}
                    {% if keyword.strip() %}
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <span class="keyword-status" data-keyword="{{ keyword.strip() }}" id="keyword-{{ loop.index0 }}">
                                <i class="fas fa-clock text-muted"></i>
                            </span>
                            <span class="ms-2">{{ keyword.strip() }}</span>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Processing Features</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <h6>What We're Collecting:</h6>
                    <ul class="small mb-0">
                        <li>Website URLs</li>
                        <li>Page titles</li>
                        <li>Search rankings</li>
                        <li>Page snippets</li>
                        <li>Exact keyword matches</li>
                        <li>All available Google results</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning">
                    <h6><i class="fas fa-bolt"></i> Powered by:</h6>
                    <ul class="small mb-0">
                        <li>Google Web Search via Serper.dev</li>
                        <li>Advanced API rotation for reliability</li>
                        <li>Intelligent pagination for maximum results</li>
                        <li>Exact keyword phrase matching</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-download"></i> Export Options</h5>
            </div>
            <div class="card-body">
                <p class="small">
                    Once processing completes, you'll be able to download:
                </p>
                <ul class="small">
                    <li><strong>Complete CSV:</strong> All URLs in one file</li>
                    <li><strong>Keyword-specific CSVs:</strong> Separate file per keyword</li>
                    <li><strong>Filtered exports:</strong> By search ranking, keyword, etc.</li>
                </ul>
                
                <div class="text-center mt-3" id="downloadSection" style="display: none;">
                    <a href="#" id="downloadBtn" class="btn btn-success btn-sm">
                        <i class="fas fa-download"></i> Download Results
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const sessionId = {{ session.id }};
const totalKeywords = {{ (session.keywords.split('\n')|length) }};
const keywords = {{ session.keywords.split('\n') | tojson }};
let startTime = new Date().getTime();
let processingStarted = false;

function updateStatus() {
    fetch(`/api/business-search-status/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            // Check if this is a bulk search
            if (data.is_bulk_search) {
                updateBulkSearchStatus(data);
            } else {
                updateSingleSearchStatus(data);
            }
        })
        .catch(error => {
            console.error('Error checking status:', error);
        });
}

function updateBulkSearchStatus(data) {
    const progress = data.progress || 0;
    const status = data.status || 'processing';
    const currentKeyword = data.current_keyword || 'Starting...';
    const totalBusinesses = data.total_businesses || 0;
    
    // Update progress bar
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressBar').textContent = Math.round(progress) + '%';
    
    // Update status
    const statusBadge = document.getElementById('statusText');
    if (status === 'completed') {
        statusBadge.className = 'badge bg-success';
        statusBadge.textContent = 'All Keywords Completed';
        document.getElementById('spinnerIcon').className = 'fas fa-check';
        
        // Show download button
        document.getElementById('downloadSection').style.display = 'block';
        document.getElementById('downloadBtn').href = `/business-search-results/${sessionId}`;
        
        clearInterval(statusInterval);
    } else if (status === 'processing') {
        statusBadge.className = 'badge bg-warning';
        statusBadge.textContent = 'Processing Keywords...';
        processingStarted = true;
    } else if (status === 'failed') {
        statusBadge.className = 'badge bg-danger';
        statusBadge.textContent = 'Failed';
        document.getElementById('spinnerIcon').className = 'fas fa-exclamation-triangle';
        clearInterval(statusInterval);
    }
    
    // Update current keyword instead of location
    document.getElementById('currentLocationLabel').textContent = 'Current Keyword:';
    document.getElementById('currentLocation').textContent = currentKeyword;
    
    // Update counters for bulk search
    document.getElementById('totalBusinesses').textContent = totalBusinesses;
    document.getElementById('keywordsProcessed').textContent = data.completed_keywords || 0;
    
    // Update processing time
    if (processingStarted) {
        const elapsed = Math.floor((new Date().getTime() - startTime) / 1000);
        document.getElementById('processingTime').textContent = elapsed + 's';
    }
    
    // Update average per keyword
    if (data.completed_keywords > 0) {
        const avgPerKeyword = Math.round(totalBusinesses / data.completed_keywords);
        document.getElementById('averagePerKeyword').textContent = avgPerKeyword;
    }
    
    // Show keyword progress section
    const keywordSection = document.getElementById('keywordProgressSection');
    keywordSection.style.display = 'block';
    
    // Update keyword progress list
    updateKeywordProgressList(data.keyword_progress);
}

function updateSingleSearchStatus(data) {
    const progress = data.progress || 0;
    const status = data.status || 'processing';
    const currentLocation = data.current_location || 'Starting...';
    const totalBusinesses = data.total_businesses || 0;
    
    // Update progress bar
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressBar').textContent = Math.round(progress) + '%';
    
    // Update status
    const statusBadge = document.getElementById('statusText');
    if (status === 'completed') {
        statusBadge.className = 'badge bg-success';
        statusBadge.textContent = 'Completed';
        document.getElementById('spinnerIcon').className = 'fas fa-check';
        
        // Show download button
        document.getElementById('downloadSection').style.display = 'block';
        document.getElementById('downloadBtn').href = `/business-search-results/${sessionId}`;
        
        clearInterval(statusInterval);
    } else if (status === 'processing') {
        statusBadge.className = 'badge bg-warning';
        statusBadge.textContent = 'Processing';
        processingStarted = true;
    } else if (status === 'failed') {
        statusBadge.className = 'badge bg-danger';
        statusBadge.textContent = 'Failed';
        document.getElementById('spinnerIcon').className = 'fas fa-exclamation-triangle';
        clearInterval(statusInterval);
    }
    
    // Update current location
    document.getElementById('currentLocation').textContent = currentLocation;
    
    // Update counters
    document.getElementById('totalBusinesses').textContent = totalBusinesses;
    
    // Calculate keywords processed
    const keywordsProcessed = Math.floor((progress / 100) * totalKeywords);
    document.getElementById('keywordsProcessed').textContent = keywordsProcessed;
    
    // Update processing time
    if (processingStarted) {
        const elapsed = Math.floor((new Date().getTime() - startTime) / 1000);
        document.getElementById('processingTime').textContent = elapsed + 's';
    }
    
    // Update average per keyword
    if (keywordsProcessed > 0) {
        const avgPerKeyword = Math.round(totalBusinesses / keywordsProcessed);
        document.getElementById('averagePerKeyword').textContent = avgPerKeyword;
    }
    
    // Update keyword status indicators
    keywords.forEach((keyword, index) => {
        const keywordElement = document.getElementById(`keyword-${index}`);
        if (keywordElement && keyword.trim()) {
            if (index < keywordsProcessed) {
                keywordElement.innerHTML = '<i class="fas fa-check text-success"></i>';
            } else if (keyword.trim() === currentLocation) {
                keywordElement.innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i>';
            } else {
                keywordElement.innerHTML = '<i class="fas fa-clock text-muted"></i>';
            }
        }
    });
}

function updateKeywordProgressList(keywordProgress) {
    const container = document.getElementById('keywordProgressList');
    
    if (!keywordProgress || keywordProgress.length === 0) {
        container.innerHTML = '<p class="text-muted">No keyword progress available</p>';
        return;
    }
    
    let html = '';
    keywordProgress.forEach(keyword => {
        const progressClass = keyword.status === 'completed' ? 'bg-success' : 
                            keyword.status === 'processing' ? 'bg-warning' : 'bg-secondary';
        
        html += `
            <div class="row mb-3 align-items-center">
                <div class="col-md-4">
                    <strong>${keyword.status_icon} ${keyword.keyword}</strong>
                </div>
                <div class="col-md-3">
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar ${progressClass}" 
                             style="width: ${keyword.progress}%" 
                             aria-valuenow="${keyword.progress}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            ${Math.round(keyword.progress)}%
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <span class="badge bg-primary">${keyword.business_count} URLs</span>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">${keyword.status_text}</small>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Check status every 2 seconds
const statusInterval = setInterval(updateStatus, 2000);
updateStatus(); // Initial check
</script>
{% endblock %}