{% extends "base.html" %}

{% block title %}Business Search Results{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-map-marked-alt"></i> Business Search Results</h2>
        <p class="text-muted">
            Found <strong>{{ results.total_businesses }}</strong> businesses for 
            "<strong>{{ results.session.keywords }}</strong>" across {{ results.session.cities|length }} cities
        </p>
        <hr>
    </div>
</div>

<!-- Summary Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4>{{ results.total_businesses }}</h4>
                <small>Total Businesses</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4>{{ results.session.cities|length }}</h4>
                <small>Cities Searched</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4>{{ "%.1f"|format(results.session.processing_time or 0) }}s</h4>
                <small>Processing Time</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4>{{ "%.1f"|format((results.total_businesses / results.session.cities|length) if results.session.cities|length > 0 else 0) }}</h4>
                <small>Avg. per City</small>
            </div>
        </div>
    </div>
</div>

<!-- Download Options -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-download"></i> Download Options</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <a href="{{ url_for('download_business_csv', session_id=results.session.id) }}" class="btn btn-success w-100 mb-2">
                            <i class="fas fa-download"></i> Download Complete CSV
                        </a>
                        <small class="text-muted">All businesses in one comprehensive file</small>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-success w-100 mb-2" onclick="downloadCityCSVs()">
                            <i class="fas fa-download"></i> Download by City
                        </button>
                        <small class="text-muted">Separate CSV file for each city</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results by City -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-city"></i> Results by City</h5>
            </div>
            <div class="card-body">
                <!-- City Tabs -->
                <ul class="nav nav-tabs" id="cityTabs" role="tablist">
                    {% for city, businesses in results.businesses_by_city.items() %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if loop.first %}active{% endif %}" 
                                id="tab-{{ loop.index0 }}" data-bs-toggle="tab" 
                                data-bs-target="#city-{{ loop.index0 }}" type="button" role="tab">
                            {{ city }} <span class="badge bg-secondary ms-1">{{ businesses|length }}</span>
                        </button>
                    </li>
                    {% endfor %}
                </ul>
                
                <!-- City Content -->
                <div class="tab-content" id="cityTabsContent">
                    {% for city, businesses in results.businesses_by_city.items() %}
                    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                         id="city-{{ loop.index0 }}" role="tabpanel">
                        
                        <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
                            <h6>{{ businesses|length }} businesses found in {{ city }}</h6>
                            <a href="{{ url_for('download_business_csv', session_id=results.session.id, city=city) }}" 
                               class="btn btn-sm btn-outline-success">
                                <i class="fas fa-download"></i> Download {{ city }} CSV
                            </a>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Business Name</th>
                                        <th>Address</th>
                                        <th>Contact</th>
                                        <th>Rating</th>
                                        <th>Website</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for business in businesses %}
                                    <tr>
                                        <td>
                                            <strong>{{ business['Business Name'] }}</strong>
                                            {% if business['Business Types'] %}
                                                <br><small class="text-muted">{{ business['Business Types'][:50] }}{% if business['Business Types']|length > 50 %}...{% endif %}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>{{ business['Address'] }}</small>
                                            {% if business['Latitude'] and business['Longitude'] %}
                                                <br><a href="https://www.google.com/maps/@{{ business['Latitude'] }},{{ business['Longitude'] }},15z" 
                                                       target="_blank" class="text-primary">
                                                    <i class="fas fa-map-marker-alt"></i> View on Maps
                                                </a>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if business['Phone'] %}
                                                <div><i class="fas fa-phone"></i> {{ business['Phone'] }}</div>
                                            {% endif %}
                                            {% if business['Email'] and business['Email'] != 'Not available' %}
                                                <div><i class="fas fa-envelope"></i> {{ business['Email'] }}</div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if business['Rating'] %}
                                                <div>
                                                    <span class="badge bg-warning">{{ business['Rating'] }}â˜…</span>
                                                    {% if business['Total Reviews'] %}
                                                        <br><small>({{ business['Total Reviews'] }} reviews)</small>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">No rating</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if business['Website'] %}
                                                <a href="{{ business['Website'] }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-external-link-alt"></i> Visit
                                                </a>
                                            {% else %}
                                                <span class="text-muted">No website</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Info -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Search Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Search Details:</strong>
                        <ul>
                            <li><strong>Keywords:</strong> {{ results.session.keywords }}</li>
                            <li><strong>Cities:</strong> {{ ", ".join(results.session.cities) }}</li>
                            <li><strong>Search Date:</strong> {{ results.session.created_at }}</li>
                            <li><strong>Processing Time:</strong> {{ "%.2f"|format(results.session.processing_time or 0) }} seconds</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <strong>Data Quality:</strong>
                        <ul>
                            <li><strong>Businesses with Phone:</strong> {{ results.businesses_by_city.values() | list | sum(start=[]) | selectattr('phone') | list | length }} / {{ results.total_businesses }}</li>
                            <li><strong>Businesses with Website:</strong> {{ results.businesses_by_city.values() | list | sum(start=[]) | selectattr('website') | list | length }} / {{ results.total_businesses }}</li>
                            <li><strong>Businesses with Ratings:</strong> {{ results.businesses_by_city.values() | list | sum(start=[]) | selectattr('rating') | list | length }} / {{ results.total_businesses }}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Back to Search -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('business_search') }}" class="btn btn-primary">
            <i class="fas fa-search"></i> Start New Business Search
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function downloadCityCSVs() {
    const cities = {{ results.session.cities | tojson }};
    const sessionId = {{ results.session.id }};
    
    cities.forEach(city => {
        const url = `/download-business-csv/${sessionId}?city=${encodeURIComponent(city)}`;
        window.open(url, '_blank');
    });
}

// Initialize Bootstrap tabs
document.addEventListener('DOMContentLoaded', function() {
    const triggerTabList = [].slice.call(document.querySelectorAll('#cityTabs button'));
    triggerTabList.forEach(function (triggerEl) {
        const tabTrigger = new bootstrap.Tab(triggerEl);
    });
});
</script>
{% endblock %}