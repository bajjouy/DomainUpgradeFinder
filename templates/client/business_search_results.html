{% extends "base.html" %}

{% block title %}Bulk Search Results{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-search"></i> {% if results.is_bulk_search %}Bulk Search Results{% else %}Search Results{% endif %}</h2>
        <p class="text-muted">
            {% if results.is_bulk_search %}
                Found <strong>{{ results.total_businesses }}</strong> URLs across <strong>{{ results.keyword_results|length }}</strong> separate keyword searches
            {% else %}
                Found <strong>{{ results.total_businesses }}</strong> URLs for "{{ results.session.keywords }}"
            {% endif %}
        </p>
        <hr>
    </div>
</div>

<!-- Keyword Summary Table -->
{% if results.is_bulk_search %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Keyword Analysis Summary</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Keyword</th>
                                <th class="text-center">URLs Found</th>
                                <th class="text-center">Percentage</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for keyword_result in results.keyword_results %}
                            <tr>
                                <td><strong>{{ keyword_result.keyword }}</strong></td>
                                <td class="text-center">
                                    <span class="badge bg-primary">{{ keyword_result.url_count }}</span>
                                </td>
                                <td class="text-center">
                                    {{ "%.1f"|format((keyword_result.url_count / results.total_businesses * 100) if results.total_businesses > 0 else 0) }}%
                                </td>
                                <td class="text-center">
                                    <a href="{{ url_for('download_keyword_csv', session_id=keyword_result.session_id) }}" class="btn btn-sm btn-success">
                                        <i class="fas fa-download"></i> CSV
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th>Total</th>
                                <th class="text-center">{{ results.total_businesses }} URLs</th>
                                <th class="text-center">100%</th>
                                <th class="text-center">
                                    <a href="{{ url_for('download_business_csv', session_id=results.session.id) }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-download"></i> All CSV
                                    </a>
                                </th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Summary Stats -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4>{{ results.total_businesses }}</h4>
                <small>Total URLs Found</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4>{% if results.is_bulk_search %}{{ results.keyword_results|length }}{% else %}1{% endif %}</h4>
                <small>Keywords Searched</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4>{{ "%.1f"|format(results.session.processing_time or 0) }}s</h4>
                <small>Processing Time</small>
            </div>
        </div>
    </div>
</div>

<!-- Download Options -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-download"></i> Download Options</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <a href="{{ url_for('download_business_csv', session_id=results.session.id) }}" class="btn btn-success w-100 mb-2">
                            <i class="fas fa-download"></i> Download Complete CSV
                        </a>
                        <small class="text-muted">All businesses in one comprehensive file</small>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-success w-100 mb-2" onclick="downloadKeywordCSVs()">
                            <i class="fas fa-download"></i> Download by Keyword
                        </button>
                        <small class="text-muted">Separate CSV file for each keyword</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results by Keyword -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-search"></i> Search Results</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Website Title</th>
                                <th>URL</th>
                                <th>Keyword</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for keyword_result in results.keyword_results %}
                                {% for business in keyword_result.businesses[:50] %}
                                <tr>
                                    <td><span class="badge bg-secondary">{{ business.rank if business.rank else loop.index }}</span></td>
                                    <td>
                                        <strong>{{ business.title if business.title else 'No Title' }}</strong>
                                        {% if business.snippet %}
                                            <br><small class="text-muted">{{ business.snippet[:100] }}{% if business.snippet|length > 100 %}...{% endif %}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ business.url }}" target="_blank" class="text-primary" title="{{ business.url }}">
                                            {{ business.url[:50] }}{% if business.url|length > 50 %}...{% endif %}
                                        </a>
                                    </td>
                                    <td><span class="badge bg-info">{{ keyword_result.keyword }}</span></td>
                                    <td>
                                        <a href="{{ business.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-external-link-alt"></i> Visit
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Info -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Search Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Search Details:</strong>
                        <ul>
                            <li><strong>Keywords:</strong> {{ results.session.keywords }}</li>
                            <li><strong>Search Type:</strong> Exact keyword web search</li>
                            <li><strong>Search Date:</strong> {{ results.session.created_at }}</li>
                            <li><strong>Processing Time:</strong> {{ "%.2f"|format(results.session.processing_time or 0) }} seconds</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <strong>Search Coverage:</strong>
                        <ul>
                            <li><strong>Total URLs Found:</strong> {{ results.total_businesses }}</li>
                            <li><strong>Keywords Searched:</strong> {{ results.keyword_results|length }}</li>
                            <li><strong>Search Engine:</strong> Google Web Search</li>
                            <li><strong>Result Type:</strong> URLs and Page Titles</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Back to Search -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('business_search') }}" class="btn btn-primary">
            <i class="fas fa-search"></i> Start New Keyword Search
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function downloadKeywordCSVs() {
    const keywords = {{ results.keyword_results | map(attribute='keyword') | list | tojson }};
    const sessionId = {{ results.session.id }};
    
    keywords.forEach(keyword => {
        const url = `/download-business-csv/${sessionId}?keyword=${encodeURIComponent(keyword)}`;
        window.open(url, '_blank');
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Keyword search results page loaded');
});
</script>
{% endblock %}