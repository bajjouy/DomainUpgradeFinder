{% extends "base.html" %}

{% block title %}API Credits Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-credit-card"></i> API Credits Management</h2>
        <p class="text-muted">Monitor and manage API key credits and usage</p>
        <hr>
    </div>
</div>

<!-- Credit Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-key fa-2x mb-2"></i>
                <h3>{{ total_keys }}</h3>
                <p class="mb-0">Total API Keys</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-coins fa-2x mb-2"></i>
                <h3>{{ "{:,.0f}".format(total_remaining) }}</h3>
                <p class="mb-0">Credits Remaining</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h3>{{ "{:,.0f}".format(total_used) }}</h3>
                <p class="mb-0">Credits Used</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card {{ 'bg-danger' if low_credit_keys|length > 0 else 'bg-info' }} text-white">
            <div class="card-body text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <h3>{{ low_credit_keys|length }}</h3>
                <p class="mb-0">Low Credit Alerts</p>
            </div>
        </div>
    </div>
</div>

<!-- Live Credit Check Results -->
<div id="live-credit-results" class="row mb-4" style="display: none;">
    <div class="col-12">
        <div class="alert alert-info">
            <h6><i class="fas fa-spinner fa-spin"></i> Checking Live Credits...</h6>
            <div id="live-credit-content"></div>
        </div>
    </div>
</div>

<!-- Low Credit Keys (< 500) -->
{% set low_keys = [] %}
{% for key in api_keys %}
    {% if key.status.value == 'ACTIVE' and key.remaining_credits < 500 %}
        {% set _ = low_keys.append(key) %}
    {% endif %}
{% endfor %}

{% if low_keys %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-exclamation-triangle"></i> ⚠️ Low Credit API Keys (< 500 credits)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Key Name</th>
                                <th>Credits Remaining</th>
                                <th>Usage Progress</th>
                                <th>Action Needed</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key in low_keys %}
                            <tr class="table-danger">
                                <td><strong>{{ key.key_name }}</strong></td>
                                <td>{{ "{:,.0f}".format(key.remaining_credits) }} / {{ "{:,.0f}".format(key.total_credits) }}</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-danger" 
                                             style="width: {{ key.credits_percentage }}%">
                                            {{ "%.1f"|format(key.credits_percentage) }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-warning text-dark">Replace Soon</span>
                                    <button class="btn btn-sm btn-outline-danger ms-1" 
                                            onclick="checkLiveCredits('{{ key.key_name }}', '{{ key.id }}')">
                                        <i class="fas fa-sync-alt"></i> Check Live
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Low Credit Alerts -->
{% if low_credit_keys %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-danger">
            <h5><i class="fas fa-exclamation-triangle"></i> Low Credit Warning</h5>
            <p><strong>{{ low_credit_keys|length }} API key(s)</strong> have less than 500 credits remaining:</p>
            <ul>
                {% for key in low_credit_keys %}
                <li><strong>{{ key.key_name }}</strong>: {{ key.remaining_credits }} credits remaining ({{ "%.1f"|format(key.credits_percentage) }}%)</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endif %}

<!-- API Keys Credit Details -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> API Key Credits (Sorted by Priority)</h5>
                <small class="text-muted">Higher priority keys are used first</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Key Name</th>
                                <th>Status</th>
                                <th>Credits</th>
                                <th>Usage</th>
                                <th>Priority Score</th>
                                <th>Last Used</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key in api_keys %}
                            <tr class="{{ 'table-danger' if key.is_low_credits and key.status.value == 'ACTIVE' else '' }}">
                                <td>
                                    <strong>{{ key.key_name }}</strong>
                                    {% if key.is_low_credits and key.status.value == 'ACTIVE' %}
                                        <span class="badge bg-danger ms-2">LOW CREDITS</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if key.status.value == 'ACTIVE' %}
                                        <span class="badge bg-success">Active</span>
                                    {% elif key.status.value == 'INACTIVE' %}
                                        <span class="badge bg-secondary">Inactive</span>
                                    {% else %}
                                        <span class="badge bg-danger">Failed</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress mb-1" style="height: 20px;">
                                        <div class="progress-bar {{ 'bg-danger' if key.credits_percentage < 20 else 'bg-warning' if key.credits_percentage < 50 else 'bg-success' }}" 
                                             style="width: {{ key.credits_percentage }}%">
                                            {{ "%.1f"|format(key.credits_percentage) }}%
                                        </div>
                                    </div>
                                    <small>{{ "{:,.0f}".format(key.remaining_credits) }} / {{ "{:,.0f}".format(key.total_credits) }}</small>
                                </td>
                                <td>
                                    <div>
                                        <strong>Used:</strong> {{ "{:,.0f}".format(key.credits_used) }}<br>
                                        <strong>Errors:</strong> {{ key.error_count }}<br>
                                        <small class="text-muted">Total requests: {{ key.usage_count }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ "%.0f"|format(key.priority_score) }}</span>
                                    {% if key in sorted_keys[:3] %}
                                        <small class="text-success d-block">High Priority</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if key.last_used %}
                                        <small>{{ key.last_used.strftime('%Y-%m-%d %H:%M') }}</small>
                                    {% else %}
                                        <small class="text-muted">Never used</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-info btn-sm" 
                                                onclick="checkLiveCredits('{{ key.key_name }}', '{{ key.id }}')">
                                            <i class="fas fa-sync-alt"></i> Check Live
                                        </button>
                                        <form method="POST" action="{{ url_for('update_api_credits', key_id=key.id) }}" class="d-inline">
                                            <div class="input-group input-group-sm" style="width: 100px;">
                                                <input type="number" class="form-control" name="total_credits" 
                                                       value="{{ key.total_credits }}" min="0" max="1000000">
                                                <button type="submit" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-save"></i>
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Credit Usage Tips -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-lightbulb"></i> Credit Management Tips</h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li><strong>Monitor regularly</strong> - Check credits weekly</li>
                    <li><strong>Set up alerts</strong> - Get notified below 500 credits</li>
                    <li><strong>Distribute load</strong> - Use multiple keys for better performance</li>
                    <li><strong>Track patterns</strong> - Monitor usage spikes and plan accordingly</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-cog"></i> Smart Rotation</h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li><strong>Priority-based</strong> - Keys with more credits used first</li>
                    <li><strong>Load balancing</strong> - Recent usage affects priority</li>
                    <li><strong>Error handling</strong> - Failed keys automatically disabled</li>
                    <li><strong>Automatic failover</strong> - Seamless switching between keys</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
function checkLiveCredits(keyName, keyId) {
    const resultsDiv = document.getElementById('live-credit-results');
    const contentDiv = document.getElementById('live-credit-content');
    
    // Show loading
    resultsDiv.style.display = 'block';
    contentDiv.innerHTML = `<p><i class="fas fa-spinner fa-spin"></i> Checking live credits for <strong>${keyName}</strong>...</p>`;
    
    // Make API call to check single key
    fetch(`/admin/api-credits/${keyId}/check-live`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error checking ${keyName}:</strong> ${data.error}
                </div>
            `;
        } else {
            const statusClass = data.credits_left < 500 ? 'danger' : (data.credits_left < 1000 ? 'warning' : 'success');
            contentDiv.innerHTML = `
                <div class="alert alert-${statusClass}">
                    <h6><strong>${keyName}</strong> Live Status:</h6>
                    <ul>
                        <li><strong>Credits Remaining:</strong> ${data.credits_left.toLocaleString()}</li>
                        <li><strong>Plan:</strong> ${data.plan}</li>
                        <li><strong>Status:</strong> ${data.credits_left < 500 ? '🚨 Critical - Replace Soon' : (data.credits_left < 1000 ? '⚠️ Low - Monitor Closely' : '✅ Good')}</li>
                    </ul>
                    <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('live-credit-results').style.display='none'">Close</button>
                </div>
            `;
        }
    })
    .catch(error => {
        contentDiv.innerHTML = `
            <div class="alert alert-danger">
                <strong>Network Error:</strong> Could not check ${keyName}. ${error.message}
            </div>
        `;
    });
}
</script>
{% endblock %}